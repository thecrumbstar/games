<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Food Dash Friends</title>
  <style>
    :root {
      --bg-1: #fff1da;
      --bg-2: #ffd9b3;
      --ink: #2f2a26;
      --accent-1: #ff6a5b;
      --accent-2: #3fb7ff;
      --accent-3: #ffd43b;
      --accent-4: #6bdf8a;
      --shadow: rgba(47, 42, 38, 0.2);
      --soft-shadow: rgba(47, 42, 38, 0.12);
      --phone: #f8f6f2;
      --card: #ffffff;
      --map: #d8f3ff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Comic Sans MS", "Trebuchet MS", "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, #fff7e8 0%, var(--bg-1) 45%, var(--bg-2) 100%);
      color: var(--ink);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 0;
    }

    .game {
      width: min(1200px, 95vw);
      height: min(760px, 92vh);
      background: linear-gradient(160deg, #fff9f0 0%, #ffe5c8 100%);
      border-radius: 32px;
      box-shadow: 0 28px 60px var(--shadow);
      position: relative;
      overflow: hidden;
      padding: 24px 28px 32px;
    }

    .bg-shape {
      position: absolute;
      border-radius: 50%;
      filter: blur(0.5px);
      opacity: 0.6;
    }

    .bg-shape.one {
      width: 380px;
      height: 380px;
      background: #ffd1cc;
      top: -120px;
      left: -120px;
    }

    .bg-shape.two {
      width: 420px;
      height: 420px;
      background: #c9f1ff;
      bottom: -180px;
      right: -140px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      position: relative;
      z-index: 2;
      gap: 12px;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: clamp(1.8rem, 2.2vw, 2.4rem);
      letter-spacing: 0.5px;
    }

    .pill {
      background: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      box-shadow: 0 8px 14px var(--soft-shadow);
      font-size: 0.9rem;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .pill span {
      font-weight: 700;
    }

    .stage {
      display: grid;
      grid-template-columns: 1.05fr 1.25fr;
      gap: 20px;
      height: calc(100% - 68px);
      position: relative;
      z-index: 2;
    }

    .panel {
      background: rgba(255, 255, 255, 0.75);
      border-radius: 24px;
      padding: 18px;
      box-shadow: 0 12px 30px var(--soft-shadow);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .stage-screen {
      position: absolute;
      inset: 0;
      padding: 18px;
      background: transparent;
      box-shadow: none;
    }

    .panel.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(12px) scale(0.98);
      transition: 0.4s ease;
    }

    .panel.active {
      opacity: 1;
      pointer-events: auto;
      transform: none;
      transition: 0.45s ease;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
    }

    .character-card {
      background: linear-gradient(160deg, #fff 0%, #ffe9d7 100%);
      border-radius: 18px;
      padding: 14px;
      box-shadow: inset 0 0 0 3px transparent, 0 10px 16px var(--soft-shadow);
      cursor: pointer;
      transition: 0.25s ease;
      text-align: center;
    }

    .character-card.selected {
      box-shadow: inset 0 0 0 3px var(--accent-2), 0 12px 20px rgba(63, 183, 255, 0.35);
      transform: translateY(-2px);
    }

    .avatar {
      width: 110px;
      height: 140px;
      margin: 0 auto 8px;
      border-radius: 20px;
      background:
        radial-gradient(circle at 32% 62%, rgba(255, 144, 144, 0.35) 0 10px, transparent 12px),
        radial-gradient(circle at 68% 62%, rgba(255, 144, 144, 0.35) 0 10px, transparent 12px),
        radial-gradient(ellipse at 50% 6%, rgba(90, 58, 47, 0.9) 0 58px, transparent 60px),
        linear-gradient(170deg, #ffd7c2 0%, #ffb3a1 100%);
      position: relative;
      box-shadow: inset 0 -10px 20px rgba(255, 255, 255, 0.4);
    }

    .avatar.girl {
      background:
        radial-gradient(circle at 32% 62%, rgba(255, 140, 190, 0.35) 0 10px, transparent 12px),
        radial-gradient(circle at 68% 62%, rgba(255, 140, 190, 0.35) 0 10px, transparent 12px),
        radial-gradient(ellipse at 50% 6%, rgba(78, 49, 74, 0.9) 0 60px, transparent 62px),
        linear-gradient(170deg, #ffe7ef 0%, #ffb8d2 100%);
    }

    .avatar::before,
    .avatar::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #2f2a26;
      top: 42px;
    }

    .avatar::before {
      left: 30px;
    }

    .avatar::after {
      right: 30px;
    }

    .avatar .mouth {
      position: absolute;
      width: 40px;
      height: 20px;
      border-radius: 0 0 20px 20px;
      background: #2f2a26;
      bottom: 36px;
      left: 50%;
      transform: translateX(-50%);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-weight: 700;
      cursor: pointer;
      background: var(--accent-1);
      color: #fff;
      box-shadow: 0 10px 16px rgba(255, 106, 91, 0.35);
      transition: 0.2s ease;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn.secondary {
      background: var(--accent-2);
      box-shadow: 0 10px 16px rgba(63, 183, 255, 0.35);
    }

    .btn.ghost {
      background: #fff;
      color: var(--ink);
      box-shadow: 0 8px 14px var(--soft-shadow);
    }

    .phone {
      background: var(--phone);
      border-radius: 24px;
      padding: 16px;
      height: 100%;
      box-shadow: inset 0 0 0 3px #e8e0d7;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .phone-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .food-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
    }

    .food-card {
      background: var(--card);
      border-radius: 16px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      box-shadow: 0 10px 16px var(--soft-shadow);
    }

    .food-thumb {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      background: linear-gradient(140deg, #ffe9a0 0%, #ff9b87 100%);
      position: relative;
      box-shadow: inset 0 -6px 10px rgba(255, 255, 255, 0.45);
    }

    .food-thumb::after {
      content: "";
      position: absolute;
      inset: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.55);
    }

    .food-thumb::before {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.6);
    }

    .food-thumb.flavor-spicy { background: linear-gradient(140deg, #ffb347 0%, #ff5c5c 100%); }
    .food-thumb.flavor-good { background: linear-gradient(140deg, #ffe69a 0%, #ffc857 100%); }
    .food-thumb.flavor-sour { background: linear-gradient(140deg, #d4ff8f 0%, #7fe37b 100%); }
    .food-thumb.flavor-bitter { background: linear-gradient(140deg, #c1d3ff 0%, #7f91ff 100%); }

    .tag {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 999px;
      background: #ffe9d1;
    }

    .map {
      background: linear-gradient(180deg, #bfe9ff 0%, #d8f3ff 60%, #bfe9ff 100%);
      border-radius: 20px;
      position: relative;
      overflow: hidden;
      height: 220px;
      box-shadow: inset 0 0 0 2px #b9e1f3;
    }

    .map .cloud {
      position: absolute;
      width: 90px;
      height: 32px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 999px;
      top: 18px;
      left: 20px;
      box-shadow: 32px 10px 0 rgba(255, 255, 255, 0.75), -26px 8px 0 rgba(255, 255, 255, 0.75);
      animation: drift 14s linear infinite;
    }

    .map .cloud.two {
      top: 54px;
      left: -40px;
      transform: scale(0.85);
      opacity: 0.8;
      animation-duration: 18s;
    }

    .map .hill {
      position: absolute;
      bottom: -40px;
      width: 180px;
      height: 140px;
      border-radius: 50%;
      background: linear-gradient(160deg, #8ee2a8 0%, #52c47b 100%);
      box-shadow: inset 0 -10px 18px rgba(255, 255, 255, 0.35);
    }

    .map .hill.one { left: 30px; }
    .map .hill.two { left: 160px; opacity: 0.8; }
    .map .hill.three { right: 40px; background: linear-gradient(160deg, #9be1ff 0%, #68bde8 100%); }

    .map .tree {
      position: absolute;
      bottom: 12px;
      width: 26px;
      height: 36px;
      background: #45b96c;
      border-radius: 50% 50% 40% 40%;
      box-shadow: inset 0 -6px 10px rgba(255, 255, 255, 0.35);
    }

    .map .tree::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 16px;
      background: #7a4b2e;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 4px;
    }

    .map .tree.one { left: 90px; }
    .map .tree.two { left: 260px; }
    .map .tree.three { right: 140px; }

    .map .river {
      position: absolute;
      bottom: 22px;
      left: -20px;
      width: 120%;
      height: 18px;
      background: linear-gradient(90deg, #7fd2ff 0%, #4fa8f0 100%);
      border-radius: 999px;
      opacity: 0.7;
    }

    .road {
      position: absolute;
      width: 120%;
      height: 8px;
      background: repeating-linear-gradient(90deg, #ffda79 0 24px, #f4c050 24px 36px);
      border-radius: 999px;
      top: 50%;
      left: -10%;
    }

    .car {
      width: 54px;
      height: 28px;
      background: var(--accent-1);
      border-radius: 14px 14px 10px 10px;
      position: absolute;
      top: calc(50% - 20px);
      left: -60px;
      box-shadow: 0 8px 12px var(--soft-shadow);
    }

    .car::before,
    .car::after {
      content: "";
      position: absolute;
      width: 12px;
      height: 12px;
      background: #2f2a26;
      border-radius: 50%;
      bottom: -6px;
    }

    .car::before {
      left: 6px;
    }

    .car::after {
      right: 6px;
    }

    .car.driving {
      animation: drive 4.5s ease-in-out forwards;
    }

    @keyframes drive {
      0% { transform: translateX(0); }
      60% { transform: translateX(360px); }
      100% { transform: translateX(520px); }
    }

    .house {
      position: absolute;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      width: 70px;
      height: 60px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 12px 20px var(--soft-shadow);
    }

    .house .light {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #ffe66b;
      border-radius: 6px;
      top: 12px;
      left: 12px;
      box-shadow: 0 0 12px rgba(255, 230, 107, 0.7);
    }

    .house::before {
      content: "";
      position: absolute;
      top: -26px;
      left: 8px;
      border-left: 27px solid transparent;
      border-right: 27px solid transparent;
      border-bottom: 26px solid #ff8a7a;
    }

    .house::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 28px;
      background: #ffd3a5;
      bottom: 6px;
      left: 24px;
      border-radius: 10px;
    }

    .character-stage {
      flex: 1;
      background: linear-gradient(180deg, #ffffff 0%, #ffe9d1 100%);
      border-radius: 20px;
      position: relative;
      padding: 16px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      overflow: hidden;
      box-shadow: inset 0 0 0 2px #f5d9c2;
    }

    .character {
      width: 180px;
      height: 260px;
      background: linear-gradient(180deg, #ffd7c2 0%, #ffb3a1 100%);
      border-radius: 26px;
      position: relative;
      box-shadow: inset 0 -12px 20px rgba(255, 255, 255, 0.3);
      transition: 0.2s ease;
      animation: idle-bob 3.4s ease-in-out infinite;
    }

    .character::before {
      content: "";
      position: absolute;
      top: 20px;
      left: 16px;
      width: 50px;
      height: 120px;
      border-radius: 30px;
      background: rgba(255, 255, 255, 0.35);
      filter: blur(0.3px);
    }

    .character .eyes,
    .character .eyes::after {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #2f2a26;
      top: 66px;
      animation: blink 4.8s infinite;
      transform-origin: center;
    }

    .character .eyes {
      left: 50px;
    }

    .character .eyes::after {
      content: "";
      left: 60px;
    }

    .character .mouth {
      position: absolute;
      width: 52px;
      height: 28px;
      border-radius: 0 0 40px 40px;
      background: #2f2a26;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      transition: 0.2s ease;
    }

    .character.chew .mouth {
      animation: chew 0.5s ease-in-out 3;
    }

    .character .tongue {
      position: absolute;
      width: 46px;
      height: 20px;
      background: #ff6a5b;
      border-radius: 0 0 20px 20px;
      bottom: 48px;
      left: 50%;
      transform: translateX(-50%) scaleY(0);
      transform-origin: top;
      transition: 0.2s ease;
    }

    .character .thumbs {
      position: absolute;
      width: 26px;
      height: 32px;
      background: #ffd3a5;
      border-radius: 10px;
      right: -10px;
      bottom: 90px;
      transform: rotate(20deg) scale(0);
      transform-origin: center;
      transition: 0.2s ease;
    }

    .character .ear-smoke {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      top: 20px;
      left: 24px;
      opacity: 0;
    }

    .character .ear-smoke.right {
      left: auto;
      right: 24px;
    }

    .character.spicy .ear-smoke {
      animation: puff 1.2s ease-out 2;
      opacity: 1;
    }

    .character.good .thumbs {
      transform: rotate(20deg) scale(1);
    }

    .character.sour .tongue {
      transform: translateX(-50%) scaleY(1);
    }

    .character.tilt {
      animation: idle-bob 3.4s ease-in-out infinite, tilt 0.6s ease-in-out 2;
    }

    @keyframes blink {
      0%, 94%, 100% { transform: scaleY(1); }
      96% { transform: scaleY(0.1); }
    }

    @keyframes idle-bob {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    @keyframes chew {
      0%, 100% { transform: translateX(-50%) scaleY(1); }
      50% { transform: translateX(-50%) scaleY(0.6); }
    }

    @keyframes tilt {
      0% { transform: rotate(0deg); }
      50% { transform: rotate(-4deg); }
      100% { transform: rotate(0deg); }
    }

    @keyframes puff {
      0% { transform: translateY(0) scale(0.8); opacity: 0.9; }
      100% { transform: translateY(-24px) scale(1.4); opacity: 0; }
    }

    @keyframes drift {
      0% { transform: translateX(0); }
      100% { transform: translateX(360px); }
    }

    .tray {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      padding: 12px;
      background: #fff1e2;
      border-radius: 16px;
      box-shadow: inset 0 0 0 2px #f3d7bf;
      min-height: 88px;
    }

    .tray .food-item {
      width: 68px;
      height: 68px;
      border-radius: 18px;
      background: linear-gradient(160deg, #ffe69e 0%, #ff9e8b 100%);
      display: grid;
      place-items: center;
      font-size: 0.7rem;
      text-align: center;
      padding: 6px;
      cursor: grab;
      user-select: none;
      box-shadow: 0 10px 18px var(--soft-shadow);
      position: relative;
    }

    .tray .food-item::after {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 14px;
      border: 2px dashed rgba(255, 255, 255, 0.55);
    }

    .tray .food-item.flavor-spicy { background: linear-gradient(160deg, #ffb347 0%, #ff5c5c 100%); }
    .tray .food-item.flavor-good { background: linear-gradient(160deg, #ffe69a 0%, #ffc857 100%); }
    .tray .food-item.flavor-sour { background: linear-gradient(160deg, #d4ff8f 0%, #7fe37b 100%); }
    .tray .food-item.flavor-bitter { background: linear-gradient(160deg, #c1d3ff 0%, #7f91ff 100%); }
    .dragging {
      position: fixed;
      z-index: 10;
      cursor: grabbing;
    }

    .map-stage {
      display: none;
    }

    .map-stage.active {
      display: block;
    }

    .feed-stage {
      display: none;
      gap: 12px;
    }

    .feed-stage.active {
      display: grid;
      grid-template-rows: 1fr auto;
    }

    .status {
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @media (max-width: 960px) {
      body {
        align-items: flex-start;
      }

      .stage {
        grid-template-columns: 1fr;
      }

      .panel {
        height: auto;
      }

      .character-stage {
        min-height: 280px;
      }

      .game {
        height: auto;
        padding: 18px;
        border-radius: 24px;
      }

      header h1 {
        font-size: 1.6rem;
      }

      .pill {
        width: 100%;
        justify-content: center;
      }

      .phone {
        min-height: 360px;
      }

      .map {
        height: 200px;
      }
    }

    @media (max-width: 640px) {
      .game {
        width: 94vw;
        padding: 16px;
      }

      header {
        margin-bottom: 8px;
      }

      .stage {
        gap: 14px;
      }

      .panel {
        padding: 14px;
      }

      .phone {
        padding: 12px;
        min-height: 320px;
      }

      .food-card {
        flex-direction: row;
        gap: 10px;
        padding: 10px;
      }

      .food-thumb {
        width: 46px;
        height: 46px;
      }

      .map {
        height: 180px;
      }

      .character-stage {
        min-height: 240px;
      }

      .character {
        transform: scale(0.9);
      }

      .tray .food-item {
        width: 62px;
        height: 62px;
      }
    }

    @media (max-width: 420px) {
      .character-card {
        padding: 10px;
      }

      .avatar {
        width: 96px;
        height: 120px;
      }

      .btn {
        padding: 8px 14px;
      }

      .pill {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <main class="game">
    <div class="bg-shape one"></div>
    <div class="bg-shape two"></div>

    <header>
      <h1>Food Dash Friends</h1>
      <div class="pill"><span id="stageLabel">Choose a friend</span> | Items: <strong id="countLabel">0/5</strong></div>
    </header>

    <section class="stage">
      <div class="panel active" id="leftPanel">
        <div id="selectPanel" class="panel stage-screen active">
          <h2>Choose your friend!</h2>
          <div class="card-grid">
            <div class="character-card" data-character="boy">
              <div class="avatar"></div>
              <h3>Boy</h3>
            </div>
            <div class="character-card" data-character="girl">
              <div class="avatar girl"></div>
              <h3>Girl</h3>
            </div>
          </div>
          <button class="btn secondary" id="startOrder" disabled>Start ordering</button>
        </div>

        <div id="orderPanel" class="panel stage-screen hidden">
          <div class="phone">
            <div class="phone-header">
              <h2>Order Food</h2>
              <span class="tag" id="limitLabel">0/5</span>
            </div>
            <div class="food-list" id="foodList"></div>
            <div class="status">
              <button class="btn" id="doneBtn" disabled>Done!</button>
              <button class="btn ghost" id="soundToggle">Sound: On</button>
            </div>
          </div>
        </div>

        <div id="mapPanel" class="panel stage-screen hidden">
          <h2>Delivery on the way!</h2>
          <div class="map">
            <div class="cloud"></div>
            <div class="cloud two"></div>
            <div class="hill one"></div>
            <div class="hill two"></div>
            <div class="hill three"></div>
            <div class="river"></div>
            <div class="tree one"></div>
            <div class="tree two"></div>
            <div class="tree three"></div>
            <div class="road"></div>
            <div class="car" id="car"></div>
            <div class="house"><div class="light"></div></div>
          </div>
          <div class="status" id="mapStatus">Driver is cruising...</div>
        </div>
      </div>

      <div class="panel active" id="rightPanel">
        <div class="character-stage" id="characterStage">
          <div class="character" id="character">
            <div class="eyes"></div>
            <div class="mouth" id="mouth"></div>
            <div class="tongue"></div>
            <div class="thumbs"></div>
            <div class="ear-smoke"></div>
            <div class="ear-smoke right"></div>
          </div>
        </div>
        <div class="feed-stage" id="feedStage">
          <div class="tray" id="tray"></div>
          <div class="status" id="feedStatus">Drag food to the mouth!</div>
          <button class="btn ghost" id="newOrderBtn" style="display:none;">New order</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const foodData = [
      { name: "Volcano Noodles", flavor: "spicy" },
      { name: "Fire Tacos", flavor: "spicy" },
      { name: "Rainbow Donut", flavor: "good" },
      { name: "Honey Pancakes", flavor: "good" },
      { name: "Lemon Bites", flavor: "sour" },
      { name: "Pickle Pops", flavor: "sour" },
      { name: "Dark Choco", flavor: "bitter" },
      { name: "Kale Chips", flavor: "bitter" },
      { name: "Galaxy Sushi", flavor: "good" },
      { name: "Berry Cloud", flavor: "good" },
      { name: "Dragon Curry", flavor: "spicy" },
      { name: "Tart Tangerine", flavor: "sour" }
    ];

    const state = {
      selected: null,
      ordered: [],
      soundOn: true
    };

    const selectPanel = document.getElementById("selectPanel");
    const orderPanel = document.getElementById("orderPanel");
    const mapPanel = document.getElementById("mapPanel");
    const feedStage = document.getElementById("feedStage");
    const startOrderBtn = document.getElementById("startOrder");
    const doneBtn = document.getElementById("doneBtn");
    const foodList = document.getElementById("foodList");
    const tray = document.getElementById("tray");
    const stageLabel = document.getElementById("stageLabel");
    const countLabel = document.getElementById("countLabel");
    const limitLabel = document.getElementById("limitLabel");
    const car = document.getElementById("car");
    const mapStatus = document.getElementById("mapStatus");
    const character = document.getElementById("character");
    const mouth = document.getElementById("mouth");
    const feedStatus = document.getElementById("feedStatus");
    const soundToggle = document.getElementById("soundToggle");
    const newOrderBtn = document.getElementById("newOrderBtn");

    const audio = {
      ctx: null,
      ensure() {
        if (!this.ctx) {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
      },
      beep(freq, duration, type = "sine", gain = 0.12) {
        if (!state.soundOn) return;
        this.ensure();
        const osc = this.ctx.createOscillator();
        const amp = this.ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        amp.gain.value = gain;
        osc.connect(amp);
        amp.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
      },
      sequence(tones) {
        if (!state.soundOn) return;
        this.ensure();
        let t = this.ctx.currentTime;
        tones.forEach(({ freq, duration, type, gain }) => {
          const osc = this.ctx.createOscillator();
          const amp = this.ctx.createGain();
          osc.type = type || "sine";
          osc.frequency.value = freq;
          amp.gain.value = gain ?? 0.12;
          osc.connect(amp);
          amp.connect(this.ctx.destination);
          osc.start(t);
          osc.stop(t + duration);
          t += duration;
        });
      },
      click() {
        this.beep(520, 0.08, "triangle", 0.08);
      },
      kaChing() {
        this.sequence([
          { freq: 660, duration: 0.09, type: "square", gain: 0.08 },
          { freq: 880, duration: 0.12, type: "square", gain: 0.1 }
        ]);
      },
      whoosh() {
        this.sequence([
          { freq: 320, duration: 0.08, type: "sawtooth", gain: 0.05 },
          { freq: 240, duration: 0.1, type: "sawtooth", gain: 0.04 }
        ]);
      },
      doorbell() {
        this.sequence([
          { freq: 880, duration: 0.18, type: "triangle", gain: 0.12 },
          { freq: 660, duration: 0.22, type: "triangle", gain: 0.12 }
        ]);
      },
      reaction(type) {
        if (type === "spicy") this.sequence([{ freq: 740, duration: 0.08 }, { freq: 520, duration: 0.14 }]);
        if (type === "good") this.sequence([{ freq: 660, duration: 0.1 }, { freq: 880, duration: 0.12 }]);
        if (type === "sour" || type === "bitter") this.sequence([{ freq: 440, duration: 0.12 }, { freq: 330, duration: 0.14 }]);
      }
    };

    document.querySelectorAll(".character-card").forEach(card => {
      card.addEventListener("click", () => {
        document.querySelectorAll(".character-card").forEach(c => c.classList.remove("selected"));
        card.classList.add("selected");
        state.selected = card.dataset.character;
        startOrderBtn.disabled = false;
        stageLabel.textContent = "Ready to order";
        audio.click();
      });
    });

    startOrderBtn.addEventListener("click", () => {
      audio.whoosh();
      selectPanel.classList.remove("active");
      selectPanel.classList.add("hidden");
      orderPanel.classList.remove("hidden");
      orderPanel.classList.add("active");
      stageLabel.textContent = "Order up";
      renderFoodList();
    });

    soundToggle.addEventListener("click", () => {
      state.soundOn = !state.soundOn;
      soundToggle.textContent = `Sound: ${state.soundOn ? "On" : "Off"}`;
      audio.click();
    });

    function renderFoodList() {
      foodList.innerHTML = "";
      foodData.forEach((food, index) => {
        const card = document.createElement("div");
        card.className = "food-card";
        card.innerHTML = `
          <div class="food-thumb flavor-${food.flavor}"></div>
          <div style="flex:1;">
            <strong>${food.name}</strong>
            <div class="tag" style="margin-top:6px;">${food.flavor}</div>
          </div>
          <button class="btn" data-index="${index}">Order</button>
        `;
        const btn = card.querySelector("button");
        btn.addEventListener("click", () => addOrder(food));
        foodList.appendChild(card);
      });
      updateCounts();
    }

    function addOrder(food) {
      if (state.ordered.length >= 5) return;
      state.ordered.push(food);
      audio.kaChing();
      updateCounts();
      if (state.ordered.length === 5) {
        doneBtn.disabled = false;
        stageLabel.textContent = "Ready to deliver";
        feedStatus.textContent = "Waiting for delivery...";
      }
    }

    function updateCounts() {
      countLabel.textContent = `${state.ordered.length}/5`;
      limitLabel.textContent = `${state.ordered.length}/5`;
      document.querySelectorAll(".food-card button").forEach(btn => {
        btn.disabled = state.ordered.length >= 5;
      });
    }

    doneBtn.addEventListener("click", () => {
      if (state.ordered.length < 5) return;
      audio.whoosh();
      orderPanel.classList.remove("active");
      orderPanel.classList.add("hidden");
      mapPanel.classList.remove("hidden");
      mapPanel.classList.add("active");
      stageLabel.textContent = "Delivery time";
      car.classList.add("driving");
      mapStatus.textContent = "Driver is on the road!";
      const driveSound = setInterval(() => audio.beep(140, 0.1, "sawtooth", 0.03), 400);
      car.addEventListener("animationend", () => {
        clearInterval(driveSound);
        mapStatus.textContent = "They made it!";
        audio.doorbell();
        showFeedingStage();
      }, { once: true });
    });

    function showFeedingStage() {
      feedStage.classList.add("active");
      newOrderBtn.style.display = "none";
      renderTray();
      stageLabel.textContent = "Feed your friend";
      feedStatus.textContent = "Drag food to the mouth!";
    }

    function renderTray() {
      tray.innerHTML = "";
      state.ordered.forEach((food, index) => {
        const item = document.createElement("div");
        item.className = `food-item flavor-${food.flavor}`;
        item.dataset.index = index;
        item.dataset.flavor = food.flavor;
        item.textContent = food.name.split(" ")[0];
        tray.appendChild(item);
      });
      setupDrag();
    }

    function setupDrag() {
      const items = tray.querySelectorAll(".food-item");
      items.forEach(item => {
        item.addEventListener("pointerdown", startDrag);
      });
    }

    function startDrag(event) {
      const item = event.currentTarget;
      const rect = item.getBoundingClientRect();
      const offsetX = event.clientX - rect.left;
      const offsetY = event.clientY - rect.top;
      item.style.position = "fixed";
      item.style.left = `${rect.left}px`;
      item.style.top = `${rect.top}px`;
      item.classList.add("dragging");
      item.setPointerCapture(event.pointerId);

      const move = (e) => {
        item.style.left = `${e.clientX - offsetX}px`;
        item.style.top = `${e.clientY - offsetY}px`;
      };

      const up = (e) => {
        item.releasePointerCapture(e.pointerId);
        item.removeEventListener("pointermove", move);
        item.removeEventListener("pointerup", up);
        item.removeEventListener("pointercancel", up);
        handleDrop(item, e.clientX, e.clientY);
      };

      item.addEventListener("pointermove", move);
      item.addEventListener("pointerup", up);
      item.addEventListener("pointercancel", up);
    }

    function handleDrop(item, x, y) {
      const mouthRect = mouth.getBoundingClientRect();
      const centerX = mouthRect.left + mouthRect.width / 2;
      const centerY = mouthRect.top + mouthRect.height / 2;
      const distance = Math.hypot(x - centerX, y - centerY);
      if (distance < 90) {
        item.style.left = `${centerX - 20}px`;
        item.style.top = `${centerY - 20}px`;
        setTimeout(() => {
          triggerReaction(item.dataset.flavor);
          item.remove();
          checkTrayEmpty();
        }, 200);
      } else {
        item.classList.remove("dragging");
        item.style.position = "";
        item.style.left = "";
        item.style.top = "";
      }
    }

    function triggerReaction(flavor) {
      character.classList.remove("spicy", "good", "sour", "chew", "tilt");
      if (flavor === "spicy") character.classList.add("spicy");
      if (flavor === "good") character.classList.add("good");
      if (flavor === "sour" || flavor === "bitter") character.classList.add("sour");
      character.classList.add("chew", "tilt");
      audio.reaction(flavor);
      setTimeout(() => character.classList.remove("spicy", "good", "sour", "chew", "tilt"), 1200);
    }

    function checkTrayEmpty() {
      if (tray.children.length === 0) {
        feedStatus.textContent = "All done! Want another round?";
        newOrderBtn.style.display = "inline-flex";
      }
    }

    function resetGame() {
      state.ordered = [];
      doneBtn.disabled = true;
      updateCounts();
      tray.innerHTML = "";
      car.classList.remove("driving");
      mapPanel.classList.remove("active");
      mapPanel.classList.add("hidden");
      orderPanel.classList.remove("active");
      orderPanel.classList.add("hidden");
      selectPanel.classList.remove("hidden");
      selectPanel.classList.add("active");
      stageLabel.textContent = "Choose a friend";
      feedStage.classList.remove("active");
      feedStatus.textContent = "Drag food to the mouth!";
      newOrderBtn.style.display = "none";
    }

    newOrderBtn.addEventListener("click", () => {
      audio.click();
      resetGame();
    });
  </script>
</body>
</html>
